@page "/chat"
@rendermode InteractiveServer
@using RagAgentApp.Models
@using RagAgentApp.Services
@inject OrchestratorService OrchestratorService

<PageTitle>RAG Agent Chat</PageTitle>

<div class="container-fluid mt-4">
    <h1 class="mb-4">RAG Agent Chat System</h1>
    <p class="lead">Ask questions and get responses from both SOP and Policy agents</p>

    <div class="row">
        <!-- User Input Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Ask a Question</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               placeholder="Type your question here..."
                               @bind="userInput"
                               @bind:event="oninput"
                               @onkeypress="HandleKeyPress"
                               disabled="@isProcessing" />
                        <button class="btn btn-primary" 
                                @onclick="SendQuery" 
                                disabled="@(isProcessing || string.IsNullOrWhiteSpace(userInput))">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Processing...</span>
                            }
                            else
                            {
                                <span>Send</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SOP Agent Response -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ðŸ“‹ SOP Agent Response</h5>
                </div>
                <div class="card-body" style="height: 500px; overflow-y: auto;">
                    @if (sopMessages.Any())
                    {
                        @foreach (var message in sopMessages)
                        {
                            <div class="message mb-3 @(message.IsUser ? "user-message" : "agent-message")">
                                <div class="message-header">
                                    <strong>@message.Sender</strong>
                                    <small class="text-muted ms-2">@message.Timestamp.ToLocalTime().ToString("HH:mm:ss")</small>
                                </div>
                                <div class="message-content mt-1">
                                    @message.Content
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center mt-5">No messages yet. Ask a question to get started!</p>
                    }
                </div>
            </div>
        </div>

        <!-- Policy Agent Response -->
        <div class="col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ðŸ“œ Policy Agent Response</h5>
                </div>
                <div class="card-body" style="height: 500px; overflow-y: auto;">
                    @if (policyMessages.Any())
                    {
                        @foreach (var message in policyMessages)
                        {
                            <div class="message mb-3 @(message.IsUser ? "user-message" : "agent-message")">
                                <div class="message-header">
                                    <strong>@message.Sender</strong>
                                    <small class="text-muted ms-2">@message.Timestamp.ToLocalTime().ToString("HH:mm:ss")</small>
                                </div>
                                <div class="message-content mt-1">
                                    @message.Content
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center mt-5">No messages yet. Ask a question to get started!</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .message {
        padding: 10px;
        border-radius: 8px;
        background-color: #f8f9fa;
    }
    
    .user-message {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
    }
    
    .agent-message {
        background-color: #f1f8e9;
        border-left: 4px solid #8bc34a;
    }
    
    .message-content {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
</style>

@code {
    private string userInput = string.Empty;
    private bool isProcessing = false;
    private List<ChatMessage> sopMessages = new();
    private List<ChatMessage> policyMessages = new();

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(userInput) && !isProcessing)
        {
            await SendQuery();
        }
    }

    private async Task SendQuery()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isProcessing)
            return;

        isProcessing = true;
        var query = userInput;
        userInput = string.Empty;

        // Add user message to both chat histories
        var userMessage = new ChatMessage
        {
            Content = query,
            Sender = "You",
            IsUser = true
        };

        sopMessages.Add(userMessage);
        policyMessages.Add(new ChatMessage
        {
            Content = query,
            Sender = "You",
            IsUser = true
        });

        StateHasChanged();

        try
        {
            // Send query to orchestrator which routes to both agents
            var responses = await OrchestratorService.RouteQueryToAgentsAsync(query);

            // Add SOP agent response
            if (responses.ContainsKey("SOP Agent"))
            {
                sopMessages.Add(new ChatMessage
                {
                    Content = responses["SOP Agent"],
                    Sender = "SOP Agent",
                    IsUser = false
                });
            }

            // Add Policy agent response
            if (responses.ContainsKey("Policy Agent"))
            {
                policyMessages.Add(new ChatMessage
                {
                    Content = responses["Policy Agent"],
                    Sender = "Policy Agent",
                    IsUser = false
                });
            }
        }
        catch (Exception ex)
        {
            var errorMessage = new ChatMessage
            {
                Content = $"Error: {ex.Message}",
                Sender = "System",
                IsUser = false
            };
            
            sopMessages.Add(errorMessage);
            policyMessages.Add(new ChatMessage
            {
                Content = $"Error: {ex.Message}",
                Sender = "System",
                IsUser = false
            });
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }
}
