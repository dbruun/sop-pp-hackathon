@page "/chat"
@rendermode InteractiveServer
@using RagAgentApp.Models
@using RagAgentApp.Services
@inject OrchestratorService OrchestratorService

<PageTitle>RAG Agent Chat</PageTitle>

<div class="container-fluid mt-4">
    <h1 class="mb-4">RAG Agent Pipeline</h1>
    <p class="lead">Specialized agent pipeline: Intake ‚Üí Search ‚Üí Writer ‚Üí Reviewer ‚Üí Executor</p>

    <div class="row">
        <!-- User Input Section -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Ask a Question</h5>
                </div>
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               placeholder="Type your question here..."
                               @bind="userInput"
                               @bind:event="oninput"
                               @onkeypress="HandleKeyPress"
                               disabled="@isProcessing" />
                        <button class="btn btn-primary" 
                                @onclick="SendQuery" 
                                disabled="@(isProcessing || string.IsNullOrWhiteSpace(userInput))">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                <span>Processing...</span>
                            }
                            else
                            {
                                <span>Send</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Question Display -->
        @if (!string.IsNullOrEmpty(currentQuestion))
        {
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">üí¨ Current Question</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0"><strong>@currentQuestion</strong></p>
                        <small class="text-muted">@questionTimestamp.ToString("MMM dd, yyyy HH:mm:ss")</small>
                    </div>
                </div>
            </div>
        }

        <!-- Pipeline Response -->
        <div class="col-12 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üîÑ Pipeline Response</h5>
                </div>
                <div class="card-body" style="height: 400px; overflow-y: auto;">
                    @if (!string.IsNullOrEmpty(pipelineResponse))
                    {
                        <div class="agent-response">
                            <div class="response-content">
                                @pipelineResponse
                            </div>
                            <small class="text-muted">@responseTimestamp.ToString("HH:mm:ss")</small>
                        </div>
                    }
                    else if (isProcessing)
                    {
                        <div class="text-center mt-5">
                            <div class="spinner-border text-success" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Pipeline is processing...</p>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center mt-5">No response yet. Ask a question to get started!</p>
                    }
                </div>
            </div>
        </div>

        <!-- Observability Section - Pipeline Execution Trace -->
        @if (pipelineTrace != null)
        {
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">üìä Pipeline Observability</h5>
                        <small>Trace spans, cost, and time per agent</small>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Total Duration</div>
                                    <div class="metric-value">@pipelineTrace.TotalDuration.TotalSeconds.ToString("F2")s</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Total Tokens</div>
                                    <div class="metric-value">@pipelineTrace.TotalTokensUsed</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Estimated Cost</div>
                                    <div class="metric-value">$@pipelineTrace.TotalEstimatedCost.ToString("F4")</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="metric-card">
                                    <div class="metric-label">Status</div>
                                    <div class="metric-value">@(pipelineTrace.Success ? "‚úÖ Success" : "‚ùå Failed")</div>
                                </div>
                            </div>
                        </div>
                        
                        <h6>Agent Execution Traces:</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Duration</th>
                                        <th>Tokens</th>
                                        <th>Cost</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var agentTrace in pipelineTrace.AgentTraces)
                                    {
                                        <tr>
                                            <td><strong>@agentTrace.AgentName</strong></td>
                                            <td>@agentTrace.Duration.TotalMilliseconds.ToString("F0")ms</td>
                                            <td>@agentTrace.TokensUsed</td>
                                            <td>$@agentTrace.EstimatedCost.ToString("F4")</td>
                                            <td>
                                                @if (agentTrace.Success)
                                                {
                                                    <span class="badge bg-success">Success</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Failed</span>
                                                    @if (!string.IsNullOrEmpty(agentTrace.ErrorMessage))
                                                    {
                                                        <small class="text-danger">@agentTrace.ErrorMessage</small>
                                                    }
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .agent-response {
        padding: 15px;
        border-radius: 8px;
        background-color: #f8f9fa;
        border-left: 4px solid #8bc34a;
    }
    
    .response-content {
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
    }

    .metric-card {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        border: 1px solid #dee2e6;
    }

    .metric-label {
        font-size: 0.85em;
        color: #6c757d;
        font-weight: 500;
        margin-bottom: 5px;
    }

    .metric-value {
        font-size: 1.5em;
        font-weight: 600;
        color: #212529;
    }
</style>

@code {
    private string userInput = string.Empty;
    private bool isProcessing = false;
    
    private string currentQuestion = string.Empty;
    private DateTime questionTimestamp = DateTime.Now;
    
    private string pipelineResponse = string.Empty;
    private DateTime responseTimestamp = DateTime.Now;
    
    private PipelineExecutionTrace? pipelineTrace = null;

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(userInput) && !isProcessing)
        {
            await SendQuery();
        }
    }

    private async Task SendQuery()
    {
        if (string.IsNullOrWhiteSpace(userInput) || isProcessing)
            return;

        isProcessing = true;
        
        // Set current question and clear previous responses
        currentQuestion = userInput;
        questionTimestamp = DateTime.Now;
        pipelineResponse = string.Empty;
        pipelineTrace = null;
        
        var query = userInput;
        userInput = string.Empty;

        StateHasChanged();

        try
        {
            // Use the specialized agent pipeline
            var (finalResponse, trace) = await OrchestratorService.ProcessQueryWithPipelineAsync(query);
            
            responseTimestamp = DateTime.Now;
            pipelineTrace = trace;
            pipelineResponse = finalResponse;
            
            isProcessing = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            responseTimestamp = DateTime.Now;
            pipelineResponse = $"Error: {ex.Message}";
            isProcessing = false;
            StateHasChanged();
        }
    }
}
